name: 微信读书同步到 Notion

on:
  workflow_dispatch:  # 手动触发
  schedule:
    - cron: "0 */3 * * *"  # 每3小时自动同步

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  sync:
    name: Sync WeRead to Notion
    runs-on: ubuntu-latest
    
    env:
      # Notion 配置（Secrets）
      NOTION_TOKEN: ${{ secrets.NOTION_TOKEN }}
      NOTION_PAGE: ${{ secrets.NOTION_PAGE }}
      
      # 微信读书 Cookie（Secrets）
      WEREAD_COOKIE: ${{ secrets.WEREAD_COOKIE }}
      
      # CookieCloud 配置（可选，用于自动更新 Cookie）
      CC_URL: ${{ secrets.CC_URL }}
      CC_ID: ${{ secrets.CC_ID }}
      CC_PASSWORD: ${{ secrets.CC_PASSWORD }}
      
      # 数据库名称（Variables，可自定义）
      BOOK_DATABASE_NAME: ${{ vars.BOOK_DATABASE_NAME || '魔法学院' }}
      AUTHOR_DATABASE_NAME: ${{ vars.AUTHOR_DATABASE_NAME || '作者' }}
      CATEGORY_DATABASE_NAME: ${{ vars.CATEGORY_DATABASE_NAME || '分类' }}
      BOOKMARK_DATABASE_NAME: ${{ vars.BOOKMARK_DATABASE_NAME || '划线' }}
      REVIEW_DATABASE_NAME: ${{ vars.REVIEW_DATABASE_NAME || '笔记' }}
      CHAPTER_DATABASE_NAME: ${{ vars.CHAPTER_DATABASE_NAME || '章节' }}
      YEAR_DATABASE_NAME: ${{ vars.YEAR_DATABASE_NAME || '年' }}
      WEEK_DATABASE_NAME: ${{ vars.WEEK_DATABASE_NAME || '周' }}
      MONTH_DATABASE_NAME: ${{ vars.MONTH_DATABASE_NAME || '月' }}
      DAY_DATABASE_NAME: ${{ vars.DAY_DATABASE_NAME || '日' }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests notion-client retrying pendulum python-dotenv

      - name: Run WeRead Sync
        run: python weread2notion.py all
